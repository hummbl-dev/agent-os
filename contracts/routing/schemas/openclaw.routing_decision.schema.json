{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://founder-mode.dev/schemas/openclaw.routing_decision.schema.json",
  "title": "openclaw.routing_decision",
  "description": "Deterministic routing decision envelope used by runtimes and logging.",
  "type": "object",
  "required": [
    "decision_id",
    "timestamp",
    "task_id",
    "trace_id",
    "selected_provider",
    "selected_model",
    "fallback_chain",
    "reason_codes",
    "constraints"
  ],
  "additionalProperties": false,
  "properties": {
    "decision_id": {
      "type": "string",
      "minLength": 1
    },
    "timestamp": {
      "type": "string",
      "format": "date-time"
    },
    "task_id": {
      "type": "string",
      "minLength": 1
    },
    "trace_id": {
      "type": "string",
      "minLength": 1
    },
    "selected_provider": {
      "type": "string",
      "minLength": 1
    },
    "selected_model": {
      "type": "string",
      "minLength": 1
    },
    "fallback_chain": {
      "type": "array",
      "minItems": 1,
      "items": {
        "$ref": "#/$defs/route_target"
      }
    },
    "reason_codes": {
      "type": "array",
      "minItems": 1,
      "uniqueItems": true,
      "items": {
        "type": "string",
        "pattern": "^[A-Z0-9_]+$"
      }
    },
    "constraints": {
      "$ref": "#/$defs/constraints"
    },
    "cost_estimate": {
      "type": "number",
      "minimum": 0
    },
    "currency": {
      "type": "string",
      "enum": ["USD", "EUR", "GBP"]
    },
    "policy_hash": {
      "type": "string",
      "pattern": "^[A-Fa-f0-9]{8,128}$"
    }
  },
  "allOf": [
    {
      "if": {
        "required": ["cost_estimate"]
      },
      "then": {
        "required": ["currency"]
      }
    }
  ],
  "$defs": {
    "route_target": {
      "type": "object",
      "required": ["provider", "model"],
      "additionalProperties": false,
      "properties": {
        "provider": {
          "type": "string",
          "minLength": 1
        },
        "model": {
          "type": "string",
          "minLength": 1
        }
      }
    },
    "constraints": {
      "type": "object",
      "required": ["privacy_class", "latency_target_ms"],
      "additionalProperties": false,
      "properties": {
        "privacy_class": {
          "type": "string",
          "enum": ["public", "internal", "restricted", "confidential"]
        },
        "latency_target_ms": {
          "type": "integer",
          "minimum": 0
        },
        "cap_action": {
          "type": "string",
          "enum": ["ALLOW", "DEGRADE", "QUEUE", "BLOCK", "NONE"]
        },
        "per_request_cap": {
          "type": "number",
          "minimum": 0
        },
        "daily_soft_cap": {
          "type": "number",
          "minimum": 0
        },
        "daily_hard_cap": {
          "type": "number",
          "minimum": 0
        },
        "max_tokens": {
          "type": "integer",
          "minimum": 0
        }
      }
    }
  }
}
